"use strict";var t=require("@sanity/client/csm"),e=require("@sanity/mutate"),n=require("@sanity/presentation-comlink"),r=require("react"),o=require("../optimistic/index.cjs");function s(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}var i=/* @__PURE__ */s(require("get-random-values-esm"));const u=/_key\s*==\s*['"](.*)['"]/,a=/^\d*:\d*$/;function c(t){return"number"==typeof t||"string"==typeof t&&/^\[\d+\]$/.test(t)}function f(t){return"string"==typeof t?u.test(t.trim()):"object"==typeof t&&"_key"in t}const p=/[^.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|$))/g,d=/_key\s*==\s*['"](.*)['"]/;function y(t,e,n){const r="string"==typeof e?function(t){if("string"!=typeof t)throw new Error("Path is not a string");const e=t.match(p);if(!e)throw new Error("Invalid path string");return e.map(l)}(e):e;if(!Array.isArray(r))throw new Error("Path must be an array or a string");let o=t;for(let t=0;t<r.length;t++){const e=r[t];if(c(e)){if(!Array.isArray(o))return n;o=o[e]}if(f(e)){if(!Array.isArray(o))return n;o=o.find((t=>t._key===e._key))}if("string"==typeof e&&(o="object"==typeof o&&null!==o?o[e]:void 0),typeof o>"u")return n}return o}function l(t){return c(t)?function(t){return Number(t.replace(/[^\d]/g,""))}(t):f(t)?function(t){return{_key:t.match(d)[1]}}(t):function(t){if("string"==typeof t&&a.test(t))return!0;if(!Array.isArray(t)||2!==t.length)return!1;const[e,n]=t;return!("number"!=typeof e&&""!==e||"number"!=typeof n&&""!==n)}(t)?function(t){const[e,n]=t.split(":").map((t=>""===t?t:Number(t)));return[e,n]}(t):t}function h(){const t=r.useCallback((t=>(o.listeners.add(t),()=>o.listeners.delete(t))),[]);return r.useSyncExternalStore(t,(()=>o.actor),(()=>o.emptyActor))}function m(t,e){let n;return(...r)=>{clearTimeout(n),n=setTimeout((()=>{t.apply(t,r)}),e)}}function b(e,r){const s=n.isMaybePreviewIframe(),i=n.isMaybePreviewWindow();if(o.isEmptyActor(r)||!s&&!i)throw new Error("The `useDocuments` hook cannot be used in this context");const u=t.getDraftId(e),a=t.getPublishedId(e),c=r.getSnapshot().context?.documents,f=c?.[u],p=c?.[a],d=f||p;if(!d)throw new Error(`Document "${e}" not found`);const y=f.getSnapshot().context?.local||p.getSnapshot().context?.local,l=new Promise((t=>{if(y)t(y);else{const e=d.on("ready",(n=>{const{snapshot:r}=n;t(r||null),e.unsubscribe()}))}}));return{draftDoc:f,draftId:u,getSnapshot:()=>l,publishedDoc:p,publishedId:a,get snapshot(){if(!y)throw new Error(`Snapshot for document "${e}" not found`);return y}}}function g(t,e){return()=>{const{draftDoc:n}=b(t,e);n.send({type:"submit"})}}function w(t,e){return n=>{const{snapshot:r}=b(t,e);return n?y(r,n):r}}function x(t,e){const{getSnapshot:n}=b(t,e);return n}function k(t,n){return async(r,o)=>{const s=b(t,n),{draftDoc:i,draftId:u,getSnapshot:a,publishedId:c}=s,{commit:f=!0}=o||{},p=await("function"==typeof r?r({draftId:u,publishedId:c,get snapshot(){return s.snapshot},getSnapshot:a}):r),d=await a();if(!d)throw new Error(`Snapshot for document "${t}" not found`);i.send({type:"mutate",mutations:[e.createIfNotExists({...d,_id:u}),e.patch(u,p)]}),f&&("object"==typeof f&&"debounce"in f?m((()=>i.send({type:"submit"})),f.debounce)():i.send({type:"submit"}))}}const I=/* @__PURE__ */(()=>{let t;return()=>{if(t)return t;t=[];for(let e=0;e<256;++e)t[e]=(e+256).toString(16).slice(1);return t}})();function E(t){const e=I();return function(t=16){const e=new Uint8Array(t);return i.default(e),e}(t).reduce(((t,n)=>t+e[n]),"").slice(0,t)}function _(t){const e="string"==typeof t?t:t.path,n=e.lastIndexOf("."),r=e.substring(n+1,e.length);if(!r.indexOf("["))throw new Error("Invalid path: not an array");const o=e.lastIndexOf("["),s=e.substring(0,o);let i,u;if(r.includes("_key")){const t=r.indexOf('"')+1,e=r.indexOf('"',t);i=r.substring(t,e),u=!0}else{const t=r.indexOf("[")+1,e=r.indexOf("]",t);i=r.substring(t,e),u=!1}if(!s||!i)throw new Error("Invalid path");return{path:s,key:i,hasExplicitKey:u}}exports.a=function(t,n,r){const{path:o,key:s}=_(t),i=E();return[e.at(o,e.insert([{_type:n,_key:i}],r,{_key:s}))]},exports.b=h,exports.c=y,exports.d=async function(t,n,r){if(!t.type)throw new Error("Node type is missing");const{path:o,key:s}=_(t),i=await n.getSnapshot(),u=y(i,o),a=y(i,t.path),c=u.findIndex((t=>t._key===s));let f=-1,p="before";if("first"===r){if(0===c)return[];f=0,p="before"}else if("last"===r){if(c===u.length-1)return[];f=-1,p="after"}else if("next"===r){if(c===u.length-1)return[];f=c,p="after"}else if("previous"===r){if(0===c)return[];f=c-1,p="before"}return[e.at(o,e.truncate(c,c+1)),e.at(o,e.insert(a,p,f))]},exports.e=function(t,n){const{path:r,key:o}=_(t),s=y(n,r).findIndex((t=>t._key===o));return[e.at(r,e.truncate(s,s+1))]},exports.f=function(t,n,r="after"){const{path:o,key:s}=_(t),i={...y(n,t.path),_key:E()};return[e.at(o,e.insert(i,r,{_key:s}))]},exports.g=_,exports.h=function(){const t=h();return r.useMemo((()=>!o.isEmptyActor(t)),[t])},exports.u=function(){const t=h();return{getDocument:r.useCallback((e=>({id:e,commit:g(e,t),get:w(e,t),getSnapshot:x(e,t),patch:k(e,t)})),[t]),mutateDocument:r.useCallback(((e,n,r)=>{const{draftDoc:o}=b(e,t),{commit:s=!0}=r||{};o.send({type:"mutate",mutations:n}),s&&("object"==typeof s&&"debounce"in s?m((()=>o.send({type:"submit"})),s.debounce)():o.send({type:"submit"}))}),[t])}};//# sourceMappingURL=mutations.cjs.map
