"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var t=require("xstate"),e=require("@sanity/mutate/_unstable_machine"),n=require("@sanity/mutate");const s=s=>{const o=t.fromPromise((async({input:t,signal:e})=>{const{id:n}=t,{snapshot:o}=await s.fetch("visual-editing/fetch-snapshot",{documentId:n},{signal:e});return o})),r=t.fromPromise((async({input:t})=>{const{transactions:e}=t;for(const t of e){const e=n.SanityEncoder.encodeTransaction(t);return s.post("visual-editing/mutate",e)}}));return e.documentMutatorMachine.provide({actions:{"send sync event to parent":t.enqueueActions((({enqueue:t})=>{t.sendParent((({context:t})=>({type:"sync",id:t.id,document:t.remote}))),t.emit((({context:t})=>({type:"ready",snapshot:t.local})))}))},actors:{"fetch remote snapshot":o,"submit mutations as transactions":r}})},o=t.setup({types:{},actions:{"emit sync event":t.emit((({event:e})=>(t.assertEvent(e,"sync"),e))),"emit mutation event":t.emit((({event:e})=>(t.assertEvent(e,"mutation"),e))),"emit rebased event":t.emit((({event:e})=>(t.assertEvent(e,["rebased.local","rebased.remote"]),e))),"emit pristine event":t.emit((({event:e})=>(t.assertEvent(e,["pristine"]),e))),"add document actor":t.assign({documents:({context:n,event:s,spawn:o})=>{t.assertEvent(s,"observe");const r=s.documentId;return n.documents[r]?n.documents:{...n.documents,[r]:o("documentMutatorMachine",{input:{id:r,client:n.client,sharedListener:n.sharedListener||e.createSharedListener(n.client)},id:r})}}}),"stop remote snapshot":t.stopChild((({context:e,event:n})=>(t.assertEvent(n,"unobserve"),e.documents[n.documentId]))),"remove remote snapshot from context":t.assign({documents:({context:e,event:n})=>{if(t.assertEvent(n,"unobserve"),!e.documents[n.documentId])return e.documents;const{[n.documentId]:s,...o}=e.documents;return o}})},actors:{documentMutatorMachine:e.documentMutatorMachine}}).createMachine({id:"dataset-mutator",context:({input:t})=>({documents:{},client:t.client,sharedListener:t.sharedListener}),on:{sync:{actions:["emit sync event"]},mutation:{actions:["emit mutation event"]},"rebased.*":{actions:["emit rebased event"]},pristine:{actions:["emit pristine event"]},observe:{actions:["add document actor"]},unobserve:{actions:["stop remote snapshot","remove remote snapshot from context"]}},initial:"pristine",states:{pristine:{}}}),r=t.createEmptyActor();exports.actor=r;const a=/* @__PURE__ */new Set;exports.createDatasetMutator=t=>o.provide({actors:{documentMutatorMachine:s(t)}}),exports.createDocumentMutator=s,exports.emptyActor=r,exports.isEmptyActor=function(t){return t===r},exports.listeners=a,exports.setActor=function(t){exports.actor=t;for(const t of a)t()};//# sourceMappingURL=index.cjs.map
