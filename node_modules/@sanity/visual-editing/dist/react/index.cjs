"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("react/jsx-runtime"),t=require("@sanity/presentation-comlink"),n=require("react"),r=require("react-dom"),i=require("@sanity/client/csm"),o=require("../_chunks-cjs/PointerEvents.cjs"),s=require("../_chunks-cjs/mutations.cjs"),a=require("../_chunks-cjs/SharedStateContext.cjs"),c=require("@sanity/mutate"),l=require("@sanity/visual-editing-csm"),d=require("scroll-into-view-if-needed"),u=require("@sanity/comlink"),p=require("xstate"),f=require("../optimistic/index.cjs"),m=require("rxjs");function h(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var g=/* @__PURE__ */h(d);const v=e=>{const{comlink:t,history:r}=e;return n.useEffect((()=>t?.on("presentation/navigate",(e=>{r?.update(e)}))),[t,r]),n.useEffect((()=>{if(r)return r.subscribe((e=>{e.title=e.title||document.title,t?.post("visual-editing/navigate",e)}))}),[t,r]),null},y=e=>{const{comlink:t}=e;return n.useEffect((()=>{const e=()=>{t.post("visual-editing/meta",{title:document.title})},n=new MutationObserver((([t])=>{"TITLE"===t.target.nodeName&&e()}));return n.observe(document.head,{subtree:!0,characterData:!0,childList:!0}),e(),()=>n.disconnect()}),[t]),null},x=n.createContext(null);function w(){const e=n.useContext(x);if(!e)throw new Error("Schema context is missing");return e}function b(e,t){if(!e.type)throw new Error("Node type is missing");return()=>t.patch((async({getSnapshot:t})=>s.e(e,await t())))}function E(e,t,n,r){if(!e.type)throw new Error("Node type is missing");return()=>t.patch((()=>s.a(e,n,r)))}function j(e,t){if(!e.type)throw new Error("Node type is missing");return()=>t.patch((async({getSnapshot:t})=>s.f(e,await t())))}function k(e){const{node:t,doc:n}=e;return n?[{type:"action",label:"Duplicate",icon:o.C,action:j(t,n),telemetryEvent:"Visual Editing Context Menu Item Duplicated"}]:[]}function M(e){const{node:t,doc:n}=e;return n?[{type:"action",label:"Remove",icon:o.R,action:b(t,n),telemetryEvent:"Visual Editing Context Menu Item Removed"}]:[]}async function S(e,t=!0){const{node:n,doc:r}=e;if(!r)return[];const i=[],a=[],[c,l,d,u]=await Promise.all([s.d(n,r,"previous"),s.d(n,r,"next"),s.d(n,r,"first"),s.d(n,r,"last")]);return d.length&&a.push({type:"action",label:"To top",icon:o.e,action:()=>r.patch(d),telemetryEvent:"Visual Editing Context Menu Item Moved"}),c.length&&a.push({type:"action",label:"Up",icon:o.f,action:()=>r.patch(c),telemetryEvent:"Visual Editing Context Menu Item Moved"}),l.length&&a.push({type:"action",label:"Down",icon:o.h,action:()=>r.patch(l),telemetryEvent:"Visual Editing Context Menu Item Moved"}),u.length&&a.push({type:"action",label:"To bottom",icon:o.U,action:()=>r.patch(u),telemetryEvent:"Visual Editing Context Menu Item Moved"}),a.length&&(i.push({type:"group",label:"Move",icon:o.S,items:a}),t&&i.push({type:"divider"})),i}const I=t=>{const{label:n,parent:r,width:i,onSelect:s,boundaryElement:a}=t;/* @__PURE__ */
return e.jsx(o.M,{fontSize:1,icon:o.b,padding:2,popover:{arrow:!1,constrainSize:!0,floatingBoundary:a,padding:0,placement:"right-start",fallbackPlacements:["left-start","right","left","right-end","left-end","bottom","top"],preventOverflow:!0,width:i,__unstable_margins:[4,4,4,4]},space:2,text:n,children:/* @__PURE__ */e.jsx(o.c,{node:r,onSelect:s})})},P=[-4,4,-4,4];function C(t){const{node:r,onDismiss:i,boundaryElement:s}=t,a=o.u(),c=n.useCallback((()=>{"action"===r.type&&(r.action?.(),i?.(),r.telemetryEvent&&a(r.telemetryEvent,null))}),[r,i,a]);if("divider"===r.type)/* @__PURE__ */
return e.jsx(o.o,{});if("action"===r.type)/* @__PURE__ */
return e.jsx(o.p,{fontSize:1,hotkeys:r.hotkeys,icon:r.icon,padding:2,space:2,text:r.label,disabled:!r.action,onClick:c});if("group"===r.type)/* @__PURE__ */
return e.jsx(o.M,{fontSize:1,icon:r.icon,padding:2,popover:{arrow:!1,constrainSize:!0,placement:"right-start",fallbackPlacements:["left-start","right","left","right-end","left-end","bottom","top"],preventOverflow:!0,__unstable_margins:P},space:2,text:r.label,children:r.items.map(((t,n)=>/* @__PURE__ */e.jsx(C,{node:t,onDismiss:i,boundaryElement:s},n)))});if("custom"===r.type){const{component:t}=r;/* @__PURE__ */
return e.jsx(t,{boundaryElement:s,sendTelemetry:a})}return null}const $=t=>{const{node:r,onDismiss:i,position:{x:a,y:c}}=t,[l,d]=n.useState(null),{getField:u}=w(),{getDocument:p}=s.u(),{field:f,parent:m}=u(r),h=n.useMemo((()=>f?.title||f?.name||"Unknown type"),[f]),[g,v]=n.useState(void 0);n.useEffect((()=>{(async()=>{const t=p(r.id);if(!t)return;const n=await function(t){const{node:n,field:r,parent:i,doc:s}=t;return"arrayItem"===r?.type?async function(e){const{node:t,field:n,doc:r}=e,i=[];return i.push(...k(e)),i.push(...M(e)),i.push(...await S(e)),i.push({type:"action",label:"Insert before",icon:o.a,action:E(t,r,n.name,"before"),telemetryEvent:"Visual Editing Context Menu Item Inserted"}),i.push({type:"action",label:"Insert after",icon:o.b,action:E(t,r,n.name,"after"),telemetryEvent:"Visual Editing Context Menu Item Inserted"}),i}({node:n,field:r,doc:s}):"union"===i?.type?async function(t){const{doc:n,node:r,parent:i}=t,s=[];if(s.push(...k(t)),s.push(...M(t)),s.push(...await S(t)),i.options?.insertMenu){const t=(i.options.insertMenu||{}).views?.some((e=>"grid"===e.name))?0:void 0;s.push({type:"custom",component:({boundaryElement:o,sendTelemetry:s})=>/* @__PURE__ */e.jsx(I,{label:"Insert before",onSelect:e=>{E(r,n,e.name,"before")(),s("Visual Editing Context Menu Item Inserted",null)},parent:i,width:t,boundaryElement:o})}),s.push({type:"custom",component:({boundaryElement:o,sendTelemetry:s})=>/* @__PURE__ */e.jsx(I,{label:"Insert after",onSelect:e=>{E(r,n,e.name,"after")(),s("Visual Editing Context Menu Item Inserted",null)},parent:i,width:t,boundaryElement:o})})}else s.push({type:"group",label:"Insert before",icon:o.a,items:i.of.filter((e=>"unionOption"===e.type)).map((e=>({type:"action",icon:o.g(e),label:"block"===e.name?"Paragraph":e.title||e.name,action:E(r,n,e.name,"before"),telemetryEvent:"Visual Editing Context Menu Item Inserted"})))}),s.push({type:"group",label:"Insert after",icon:o.b,items:i.of.filter((e=>"unionOption"===e.type)).map((e=>({type:"action",label:"block"===e.name?"Paragraph":e.title||e.name,icon:o.g(e),action:E(r,n,e.name,"after"),telemetryEvent:"Visual Editing Context Menu Item Inserted"})))});return s}({node:n,parent:i,doc:s}):Promise.resolve([])}({node:r,field:f,parent:m,doc:t});v(n)})()}),[f,r,m,p]);const y=n.useMemo((()=>({getBoundingClientRect:()=>({bottom:c,left:a,right:a,top:c,width:0,height:0})})),[a,c]),x=n.useMemo((()=>o.g(f)),[f]);/* @__PURE__ */
return e.jsx(o.i,{setBoundaryElement:d,onDismiss:i,children:/* @__PURE__ */e.jsx(o.j,{__unstable_margins:P,arrow:!1,open:!0,placement:"right-start",referenceElement:y,content:/* @__PURE__ */e.jsxs(o.k,{style:{minWidth:120,maxWidth:160},children:[
/* @__PURE__ */e.jsxs(o.F,{gap:2,padding:2,children:[
/* @__PURE__ */e.jsx(o.l,{flex:"none",children:g?/* @__PURE__ */e.jsx(o.T,{size:1,children:x}):/* @__PURE__ */e.jsx(o.m,{size:1})}),
/* @__PURE__ */e.jsx(o.n,{flex:1,space:2,children:/* @__PURE__ */e.jsx(o.T,{size:1,weight:"semibold",children:g?h:"Loading..."})})]}),g&&/* @__PURE__ */e.jsxs(e.Fragment,{children:[
/* @__PURE__ */e.jsx(o.o,{}),g.map(((t,n)=>/* @__PURE__ */e.jsx(C,{node:t,onDismiss:i,boundaryElement:l},n)))]})]}),children:/* @__PURE__ */e.jsx("div",{style:{position:"absolute",left:a,top:c}},`${a}-${c}`)})})};function D(e,t){try{const n=new URL(e,typeof location>"u"?void 0:location.origin);if(n.hash){const e=new URL(D(n.hash.slice(1),t));return`${n.origin}${n.pathname}${n.search}#${e.pathname}${e.search}`}return n.searchParams.set("preview",t),n.toString()}catch{return e}}const T=n.createContext(null),R=o.d(o.q)`
  background-color: var(--overlay-bg);
  border-radius: 3px;
  pointer-events: none;
  position: absolute;
  will-change: transform;
  box-shadow: var(--overlay-box-shadow);
  transition: none;

  --overlay-bg: transparent;
  --overlay-box-shadow: inset 0 0 0 1px transparent;

  [data-overlays] & {
    --overlay-bg: color-mix(in srgb, transparent 95%, var(--card-focus-ring-color));
    --overlay-box-shadow: inset 0 0 0 2px
      color-mix(in srgb, transparent 50%, var(--card-focus-ring-color));
  }

  [data-fading-out] & {
    transition:
      box-shadow 1550ms,
      background-color 1550ms;

    --overlay-bg: rgba(0, 0, 255, 0);
    --overlay-box-shadow: inset 0 0 0 1px transparent;
  }

  &[data-focused] {
    --overlay-box-shadow: inset 0 0 0 1px var(--card-focus-ring-color);
  }

  &[data-hovered]:not([data-focused]) {
    transition: none;
    --overlay-box-shadow: inset 0 0 0 2px var(--card-focus-ring-color);
  }

  /* [data-unmounted] & {
    --overlay-box-shadow: inset 0 0 0 1px var(--card-focus-ring-color);
  } */

  :link {
    text-decoration: none;
  }
`,A=o.d(o.F)`
  bottom: 100%;
  cursor: pointer;
  pointer-events: none;
  position: absolute;
  right: 0;

  [data-hovered] & {
    pointer-events: all;
  }

  [data-flipped] & {
    bottom: auto;
    top: 100%;
  }
`,_=o.d(o.F)`
  bottom: 100%;
  cursor: pointer;
  pointer-events: none;
  position: absolute;
  left: 0;

  [data-hovered] & {
    pointer-events: all;
  }

  [data-flipped] & {
    bottom: auto;
    top: 100%;
  }
`,z=o.d(o.q)`
  cursor: pointer;
  background-color: var(--card-focus-ring-color);
  right: 0;
  border-radius: 3px;

  & [data-ui='Text'] {
    color: #fff;
    white-space: nowrap;
  }
`,q=o.d(o.F)`
  display: flex;
  align-items: center;
  background-color: var(--card-focus-ring-color);
  right: 0;
  border-radius: 3px;
  & [data-ui='Text'],
  & [data-sanity-icon] {
    color: #fff;
    white-space: nowrap;
  }
`,F=t=>{const{element:r,focused:s,componentResolver:a,node:c,showActions:d,draggable:u}=t,{getField:p,getType:f}=w(),m=f(c),{field:h,parent:g}=p(c),v="path"in c?function(e){const{id:t,type:n,path:r,baseUrl:o,tool:s,workspace:a}=e;return i.createEditUrl({baseUrl:o,workspace:a,tool:s,type:n,id:t,path:l.pathToUrlString(i.studioPath.fromString(r))})}(c):c.href,y=function(){const e=n.useContext(T);if(!e)throw new Error("Preview Snapshots context is missing");return e}(),x=n.useMemo((()=>{if("path"in c)return y.find((e=>e._id===c.id))?.title}),[c,y]),b=n.useMemo((()=>{if(!("path"in c)||!h||!m)return;const e=h.value.type;return{document:m,element:r,field:h,focused:!!s,node:c,parent:g,type:e}}),[m,r,h,s,c,g]),E=function(e,t){return n.useMemo((()=>{if(!e)return;const r=t?.(e);return r?(i=r,n.isValidElement(i)?r:(Array.isArray(r)?r:[r]).map((e=>"object"==typeof e&&"component"in e?e:{component:e,props:{}}))):void 0;var i}),[t,e])}(b,a),j=m?.icon?/* @__PURE__ */e.jsx("div",{dangerouslySetInnerHTML:{__html:m.icon}}):/* @__PURE__ */e.jsx(o.r,{});/* @__PURE__ */
return e.jsxs(e.Fragment,{children:[d?/* @__PURE__ */e.jsx(A,{gap:1,paddingY:1,"data-sanity-overlay-element":!0,children:/* @__PURE__ */e.jsx(U,{href:v})}):null,x&&/* @__PURE__ */e.jsx(_,{gap:1,paddingY:1,children:/* @__PURE__ */e.jsxs(q,{gap:2,padding:2,children:[u&&/* @__PURE__ */e.jsx(o.l,{marginRight:1,children:/* @__PURE__ */e.jsx(o.T,{className:"drag-handle",size:0,children:/* @__PURE__ */e.jsx(o.D,{})})}),
/* @__PURE__ */e.jsx(o.T,{size:0,children:j}),
/* @__PURE__ */e.jsx(o.T,{size:1,weight:"medium",children:x})]})}),Array.isArray(E)?E.map((({component:t,props:n},r)=>/* @__PURE__ */e.jsx(t,{PointerEvents:o.P,...b,...n},r))):E]})},V=n.memo((function(t){const{draggable:r,focused:i,hovered:o,rect:s,wasMaybeCollapsed:a,enableScrollIntoView:c}=t,l=n.useRef(null),d=n.useRef(!1),u=n.useMemo((()=>({width:`${s.w}px`,height:`${s.h}px`,transform:`translate(${s.x}px, ${s.y}px)`})),[s]);n.useEffect((()=>{if(!d.current&&!a&&!0===i&&l.current&&c){const e=l.current;g.default(l.current,{behavior:t=>{0!==t.length&&e.scrollIntoView({behavior:"smooth",block:"center",inline:"nearest"})},scrollMode:"if-needed",block:"center",inline:"nearest"})}d.current=!0===i}),[i,a,c]);const[p,f]=n.useState(!1);return n.useEffect((()=>{if(!l.current||!o)return;const e=new IntersectionObserver((([e])=>{f(e.boundingClientRect.top<0)}),{threshold:1});return e.observe(l.current),()=>e.disconnect()}),[o,p]),/* @__PURE__ */e.jsx(R,{"data-focused":i?"":void 0,"data-hovered":o?"":void 0,"data-flipped":p?"":void 0,"data-draggable":r?"":void 0,ref:l,style:u,children:o&&/* @__PURE__ */e.jsx(F,{...t})})})),U=n.memo((function(t){const r=n.useSyncExternalStore(n.useCallback((e=>{const t=()=>e();return window.addEventListener("popstate",t),()=>window.removeEventListener("popstate",t)}),[]),(()=>window.location.href)),i=n.useMemo((()=>D(t.href,r)),[t.href,r]);/* @__PURE__ */
return e.jsx(o.l,{as:"a",href:i,target:"_blank",rel:"noopener noreferrer",children:/* @__PURE__ */e.jsx(z,{padding:2,children:/* @__PURE__ */e.jsx(o.T,{size:1,weight:"medium",children:"Open in Studio"})})})})),L=({dragGroupRect:t})=>/* @__PURE__ */e.jsx("div",{style:{position:"absolute",top:`${t.y}px`,left:`${t.x}px`,width:t.w-1+"px",height:t.h-1+"px",border:"1px dashed #f0709b",pointerEvents:"none"}});function O(e,t,n){return e*(1-n)+t*n}const N=({dragInsertPosition:t})=>{if(null===t)return;let n=0,r=0,i=0,o=0;const s=.0125;if("horizontal"==(t?.left||t?.right?"horizontal":"vertical")){const{left:e,right:a}=t;if(i=6,a&&e){const t=e.rect.x+e.rect.w,i=a.rect.x,c=Math.min(a.rect.h,e.rect.h)*s;n=O(t,i,.5)-3,r=e.rect.y+c,o=Math.min(a.rect.h,e.rect.h)-2*c}else if(a&&!e){const e=a.rect.h*s;n=a.rect.x-3,r=a.rect.y+e,o=a.rect.h-2*e}else if(e&&!a){const t=e.rect.h*s;n=e.rect.x+e.rect.w-3,r=e.rect.y+t,o=e.rect.h-2*t}}else{const{bottom:e,top:a}=t;if(e&&a){const t=Math.min(a.rect.x,e.rect.x),c=a.rect.y+a.rect.h,l=e.rect.y,d=Math.min(e.rect.w,a.rect.w)*s;o=6,n=t+d,r=O(c,l,.5)-3,i=Math.max(e.rect.w,a.rect.w)-2*d}else if(e&&!a){const t=e.rect.w*s;n=e.rect.x+t,r=e.rect.y-3,i=e.rect.w-2*t,o=6}else if(a&&!e){const e=a.rect.w*s;n=a.rect.x+e,r=a.rect.y+a.rect.h-3,i=a.rect.w-2*e,o=6}}/* @__PURE__ */
return e.jsx("div",{style:{position:"absolute",width:`${i}px`,height:`${o}px`,transform:`translate(${n}px, ${r}px)`,background:"#556bfc",border:"2px solid white",borderRadius:"999px",zIndex:"999999"}})},W=o.d.div`
  --drag-preview-opacity: 0.98;
  --drag-preview-skeleton-stroke: #ffffff;

  @media (prefers-color-scheme: dark) {
    --drag-preview-skeleton-stroke: #383d51;
  }

  position: fixed;
  display: grid;
  transform: ${({$scaleFactor:e,$width:t,$height:n})=>`translate(calc(var(--drag-preview-x) - ${t/2}px), calc(var(--drag-preview-y) - ${n/2}px)) scale(${e})`};
  width: ${({$width:e})=>`${e}px`};
  height: ${({$height:e})=>`${e}px`};
  z-index: 9999999;
  opacity: var(--drag-preview-opacity);
  cursor: move;

  .drag-preview-content-wrapper {
    position: relative;
    width: 100%;
    height: 100%;
    container-type: inline-size;
  }

  [data-ui='card'] {
    position: relative;
    width: 100%;
    height: 100%;
  }

  .drag-preview-skeleton {
    position: absolute;
    inset: 0;

    rect {
      stroke: var(--drag-preview-skeleton-stroke);
    }
  }

  .drag-preview-handle {
    position: absolute;
    top: 4cqmin;
    left: 4cqmin;
    width: 6cqmin;
    fill: var(--drag-preview-handle-fill);
  }
`,G=({skeleton:t})=>{const n=Math.min(t.maxWidth,window.innerWidth/2),r=t.w>n?n/t.w:1,i=t.offsetX*r,s=t.offsetY*r,a=o.s(),c=o.t(),l=c.radius[(p=t.w,f=c.radius.length-2,~~function(e,t,n){return e<1?1:e>n?n:e}((p-0)*(f-1)/1920+1,0,f))],d=t.childRects.filter((e=>"IMG"===e.tagName)),u=t.childRects.filter((e=>"IMG"!==e.tagName));var p,f;/* @__PURE__ */
return e.jsx(W,{$width:t.w,$height:t.h,$offsetX:i,$offsetY:s,$scaleFactor:r,children:/* @__PURE__ */e.jsx(o.q,{radius:l,shadow:4,overflow:"hidden",tone:"transparent",scheme:a?"dark":"light",children:/* @__PURE__ */e.jsx("div",{className:"drag-preview-content-wrapper",children:/* @__PURE__ */e.jsx("svg",{className:"drag-preview-skeleton",viewBox:`0 0 ${t.w} ${t.h}`,children:[...d,...u].map(((t,n)=>/* @__PURE__ */e.jsx("rect",{x:t.x,y:t.y,width:t.w,height:t.h,fill:c.color.skeleton.from},n)))})})})})},K=o.d(o.q)`
  position: fixed;
  bottom: 2rem;
  left: 2rem;
`,B=()=>/* @__PURE__ */e.jsx(K,{padding:2,shadow:2,radius:2,style:{zIndex:"999999"},children:/* @__PURE__ */e.jsxs(o.F,{align:"center",gap:2,children:[
/* @__PURE__ */e.jsx(o.H,{keys:["Shift"]}),
/* @__PURE__ */e.jsx(o.T,{size:1,children:"Zoom Out"}),
/* @__PURE__ */e.jsx(o.E,{})]})}),Y=(e,t)=>{const{type:n}=t;switch(n){case"element/register":return e.find((e=>e.id===t.id))?e:[...e,{id:t.id,activated:!1,element:t.element,focused:!1,hovered:!1,rect:t.rect,sanity:t.sanity,dragDisabled:t.dragDisabled}];case"element/activate":return e.map((e=>e.id===t.id?{...e,activated:!0}:e));case"element/update":return e.map((e=>e.id===t.id?{...e,sanity:t.sanity,rect:t.rect}:e));case"element/unregister":return e.filter((e=>e.id!==t.id));case"element/deactivate":return e.map((e=>e.id===t.id?{...e,activated:!1,hovered:!1}:e));case"element/mouseenter":return e.map((e=>e.id===t.id?{...e,rect:t.rect,hovered:!0}:{...e,hovered:!1}));case"element/mouseleave":return e.map((e=>e.id===t.id?{...e,hovered:!1}:e));case"element/updateRect":return e.map((e=>e.id===t.id?{...e,rect:t.rect}:e));case"element/click":return e.map((e=>({...e,focused:e.id===t.id&&"clicked"})));case"overlay/blur":case"presentation/blur":return e.map((e=>({...e,focused:!1})));case"presentation/focus":{const n=e.find((e=>"clicked"===e.focused));return e.map((e=>{const r="path"in e.sanity&&e.sanity.id===t.data.id&&e.sanity.path===t.data.path;return n&&e===n&&r?e:{...e,focused:r&&n?"duplicate":r}}))}default:return e}};function H(e,t){const{type:n}=t;let{contextMenu:r,focusPath:i,perspective:o,isDragging:s,dragInsertPosition:a,dragShowMinimap:c,dragShowMinimapPrompt:l,dragSkeleton:d,dragMinimapTransition:u,dragGroupRect:p}=e,f=!1;if("presentation/focus"===n){const n=e.focusPath;i=t.data.path,n!==i&&(f=n.slice(i.length).startsWith("["))}return"presentation/perspective"===n&&(o=t.data.perspective),"element/contextmenu"===n&&(r="sanity"in t?{node:t.sanity,position:t.position}:null),("element/click"===n||"element/mouseleave"===n||"overlay/blur"===n||"presentation/blur"===n||"presentation/focus"===n)&&(r=null),"overlay/dragUpdateInsertPosition"===n&&(a=t.insertPosition),"overlay/dragStart"===n&&(s=!0),"overlay/dragUpdateSkeleton"===t.type&&(d=t.skeleton),"overlay/dragEnd"===n&&(s=!1),"overlay/dragToggleMinimapPrompt"===t.type&&(l=t.display),"overlay/dragStartMinimapTransition"===n&&(u=!0),"overlay/dragEndMinimapTransition"===n&&(u=!1),"overlay/dragUpdateGroupRect"===n&&(p=t.groupRect),"overlay/dragToggleMinimap"===n&&(c=t.display),{...e,contextMenu:r,elements:Y(e.elements,t),dragInsertPosition:a,dragSkeleton:d,dragGroupRect:p,isDragging:s,focusPath:i,perspective:o,wasMaybeCollapsed:f,dragShowMinimap:c,dragShowMinimapPrompt:l,dragMinimapTransition:u}}const X=function(t){const{comlink:r,children:i}=t,[o,s]=n.useState([]),a=n.useCallback((async e=>{if(r)try{const t=await r.fetch("visual-editing/preview-snapshots",void 0,{signal:e,suppressWarnings:!0});s(t.snapshots)}catch{}}),[r]);n.useEffect((()=>{if(!r)return;const e=new AbortController,t=r.onStatus((()=>{a(e.signal)}),"connected");return()=>{e.abort(),t()}}),[r,a]),n.useEffect((()=>r?.on("presentation/preview-snapshots",(e=>{s(e.snapshots)}))),[r]);const c=n.useMemo((()=>o),[o]);/* @__PURE__ */
return e.jsx(T.Provider,{value:c,children:i})};function J(e){return"path"in e}function Z(e){return"document"===e.type}function Q(e){return"type"===e.type}const ee=function(t){const{comlink:r,children:i,elements:o}=t,[s,a]=n.useState(/* @__PURE__ */new Map),[c,l]=n.useState(null),d=n.useCallback((async e=>{if(r)try{const t=await r.fetch("visual-editing/schema",void 0,{signal:e,suppressWarnings:!0});l(t.schema)}catch{}}),[r]);n.useEffect((()=>{if(!r)return;const e=new AbortController,t=r.onStatus((()=>{d(e.signal)}),"connected");return()=>{e.abort(),t()}}),[r,d]);const u=n.useRef([]);n.useEffect((()=>{const e=new AbortController,t=function(e){return e.reduce(((e,t)=>{const{sanity:n}=t;if(!("id"in n)||!n.path.includes("[_key=="))return e;const r=function(e){return e.split(".").toReversed().reduce(((e,t)=>e.length?[t,...e]:t.includes("[_key==")?[t]:[]),[]).join(".")}(n.path);return e.find((e=>e.id===n.id&&e.path===r))||e.push({id:n.id,path:r}),e}),[])}(o);return t.some((e=>!u.current.find((({id:t,path:n})=>t===e.id&&n===e.path))))&&(async(e,t)=>{if(e.length&&r)try{const n=await r.fetch("visual-editing/schema-union-types",{paths:e},{signal:t,suppressWarnings:!0});a(n.types),u.current=e}catch{}})(t,e.signal),()=>e.abort()}),[r,o]);const p=n.useCallback(((e,t)=>{const n=t||"document";if(!c||"string"!=typeof e&&(!J(e)||!Array.isArray(c)))return;const r="string"==typeof e?e:e.type,i="document"===n?Z:Q;return c.filter(i).find((e=>e.name===r))}),[c]),f=n.useCallback((e=>{if(!J(e))return{field:void 0,parent:void 0};const t=p(e);if(!t)return{field:void 0,parent:void 0};const n=e.path.split(".").flatMap((e=>e.includes("[")?e.split(/(\[.+\])/,2):[e]));try{return function t(n,r,i,o=[]){if(!n)return{field:void 0,parent:void 0};const[a,...c]=r;if("fields"in n){const e=n.fields[a];if(!e&&"rest"in n)return t(n.rest,r,n,o);if(!c.length)return{field:e,parent:i};if(!e)throw new Error(`[@sanity/visual-editing] No field could be resolved at path: "${[...o,...r].join(".")}"`);return t(e.value,c,n,[...o,a])}if("array"===n.type)return t(n.of,r,n,o);if("arrayItem"===n.type)return c.length?t(n.value,c,n,[...o,a]):{field:n,parent:i};if("union"===n.type){const r=a.startsWith("[_key==")?s?.get(e.id)?.get([o.join("."),a].filter(Boolean).join("")):a;return t(n.of.find((e=>"unionOption"===e.type?e.name===r:e)),c,n,[...o,a])}if("unionOption"===n.type)return a?t(n.value,r,n,o):{field:n,parent:i};if("inline"===n.type)return t(p(n.name,"type").value,r,n,o);throw new Error(`[@sanity/visual-editing] No field could be resolved at path: "${[...o,...r].join(".")}"`)}(t,n,void 0)}catch(e){return e instanceof Error&&console.warn(e.message),{field:void 0,parent:void 0}}}),[p,s]),m=n.useMemo((()=>({getField:f,getType:p,resolvedTypes:s,schema:c||[]})),[f,p,s,c]);/* @__PURE__ */
return e.jsx(x.Provider,{value:m,children:i})},te=(()=>{let e={};const t=/* @__PURE__ */new Set;return{getState:()=>e,setState:n=>{e=n(e),t.forEach((e=>e()))},subscribe:e=>(t.add(e),()=>t.delete(e))}})(),ne=t=>{const{comlink:r,children:i}=t;n.useEffect((()=>r?.on("presentation/shared-state",(e=>{"value"in e?te.setState((t=>({...t,[e.key]:e.value}))):te.setState((t=>Object.fromEntries(Object.entries(t).filter((([t])=>t!==e.key)))))}))),[r]),n.useEffect((()=>{(async function(){const e=await(r?.fetch("visual-editing/shared-state",void 0,{suppressWarnings:!0}));e&&te.setState((()=>e.state))})().catch((e=>{console.debug(e),console.warn("[@sanity/visual-editing]: Failed to fetch shared state. Check your version of `sanity` is up-to-date")}))}),[r]);const o=n.useMemo((()=>({comlink:r,store:te})),[r]);/* @__PURE__ */
return e.jsx(a.S.Provider,{value:o,children:i})},re=({children:t,comlink:r})=>{const i=n.useCallback(((e,t)=>{if(!r)return;const n=o.w[e];if(!n)throw new Error(`Telemetry event: ${e} does not exist`);r.post("visual-editing/telemetry-log",{event:n,data:t})}),[r]);/* @__PURE__ */
return e.jsx(o.v.Provider,{value:i,children:t})},ie=o.d.div`
  background-color: transparent;
  direction: ltr;
  inset: 0;
  pointer-events: none;
  position: absolute;
  width: 100%;
  height: 100%;
  z-index: ${({$zIndex:e})=>e??"9999999"};
`;function oe(e){let t,n;return t=requestAnimationFrame((()=>{n=requestAnimationFrame(e)})),()=>{void 0!==t&&cancelAnimationFrame(t),void 0!==n&&cancelAnimationFrame(n)}}const se=e=>{const{documentIds:t}=e,[r,o]=n.useState([]);n.useEffect((()=>{o((e=>{const n=Array.from(new Set(t));return e.length===n.length&&0===e.reduce(((e,t)=>e.filter((e=>e!==t))),n)?.length?e:n}))}),[t]);const a=s.b();return n.useEffect((()=>{for(const e of r)a.send({type:"observe",documentId:i.getDraftId(e)}),a.send({type:"observe",documentId:i.getPublishedId(e)});return()=>{for(const e of r)a.send({type:"unobserve",documentId:i.getDraftId(e)}),a.send({type:"unobserve",documentId:i.getPublishedId(e)})}}),[a,r]),null},ae=e=>{const{comlink:t,dispatch:r,inFrame:i,inPopUp:l,onDrag:d,overlayEnabled:u,rootElement:p}=e,{dispatchDragEndEvent:f}=function(){const{getDocument:e}=s.u();return n.useEffect((()=>{const t=t=>{const{insertPosition:n,target:r,preventInsertDefault:i}=t.detail;if(i)return;const o=function(e){if(e){const{top:t,right:n,bottom:r,left:i}=e;if(i||t)return{node:(i??t).sanity,position:"after"};if(n||r)return{node:(n??r).sanity,position:"before"}}}(n);if(o){const t=e(r.id),{node:n,position:i}=o,{key:a,hasExplicitKey:l}=s.g(r),{path:d,key:u}=s.g(n);d&&u&&u!==a&&t.patch((async({getSnapshot:e})=>{const t=await e(),n=s.c(t,r.path);return l?[c.at(d,c.remove({_key:a})),c.at(d,c.insert(n,i,{_key:u}))]:[c.at(d,c.remove(~~a)),c.at(d,c.insert(n,i,u>a?~~u-1:~~u))]}))}};return window.addEventListener("sanity/dragEnd",t),()=>{window.removeEventListener("sanity/dragEnd",t)}}),[e]),{dispatchDragEndEvent:n.useCallback((e=>{const t=new CustomEvent("sanity/dragEnd",{detail:e,cancelable:!0});window.dispatchEvent(t)}),[])}}(),m=o.u(),h=function(e,t,r,i){const o=n.useRef(void 0),c=s.h();return n.useEffect((()=>{if(e)return o.current=a.c({handler:t,overlayElement:e,inFrame:r,inPopUp:i,optimisticActorReady:c}),()=>{o.current?.destroy(),o.current=void 0}}),[e,t,r,i,c]),o}(p,n.useCallback((e=>{if("element/click"===e.type){const{sanity:n}=e;t?.post("visual-editing/focus",n),m("Visual Editing Overlay Clicked",null)}else if("overlay/activate"===e.type)t?.post("visual-editing/toggle",{enabled:!0});else if("overlay/deactivate"===e.type)t?.post("visual-editing/toggle",{enabled:!1});else if("overlay/dragEnd"===e.type){const{insertPosition:t,target:n,dragGroup:r,flow:i,preventInsertDefault:o}=e;f({insertPosition:t,target:n,dragGroup:r,flow:i,preventInsertDefault:o}),t&&m("Visual Editing Drag Sequence Completed",null)}else{if("overlay/dragUpdateCursorPosition"===e.type)return void d(e.x,e.y);if("overlay/dragToggleMinimap"===e.type&&!0===e.display)m("Visual Editing Drag Minimap Enabled",null);else if("overlay/setCursor"===e.type){const{element:t,cursor:n}=e;n?t.style.cursor=n:t.style.removeProperty("cursor")}}r(e)}),[t,r,f,d,m]),i,l);return n.useEffect((()=>{u?h.current?.activate():h.current?.deactivate()}),[h,u]),null},ce=t=>{const{comlink:r,componentResolver:i,inFrame:c,inPopUp:l,zIndex:d}=t,[u,p]=n.useState(),f=o.s(),[{contextMenu:m,dragInsertPosition:h,dragShowMinimap:g,dragShowMinimapPrompt:v,dragSkeleton:y,elements:x,isDragging:w,perspective:b,wasMaybeCollapsed:E,dragMinimapTransition:j,dragGroupRect:k},M]=n.useReducer(H,{contextMenu:null,dragInsertPosition:null,dragShowMinimap:!1,dragShowMinimapPrompt:!1,dragSkeleton:null,elements:[],focusPath:"",isDragging:!1,perspective:"published",wasMaybeCollapsed:!1,dragMinimapTransition:!1,dragGroupRect:null}),[S,I]=n.useState(null),[P,C]=n.useState(!0);n.useEffect((()=>{const e=[r?.on("presentation/focus",(e=>{M({type:"presentation/focus",data:e})})),r?.on("presentation/blur",(e=>{M({type:"presentation/blur",data:e})})),r?.on("presentation/toggle-overlay",(()=>{C((e=>!e))})),r?.onStatus((e=>{p(e)}))].filter(Boolean);return()=>e.forEach((e=>e()))}),[r]),function(e,t){n.useEffect((()=>{const n=new AbortController;e?.fetch("visual-editing/fetch-perspective",void 0,{signal:n.signal,suppressWarnings:!0}).then((e=>{t({type:"presentation/perspective",data:e})})).catch((()=>{}));const r=e?.on("presentation/perspective",(e=>{t({type:"presentation/perspective",data:e})}));return()=>{r?.(),n.abort()}}),[e,t])}(r,M),function(e,t,r){const i=n.useRef(void 0),o=n.useCallback(((t,n)=>{e?.post("visual-editing/documents",{documents:t,perspective:n})}),[e]);n.useEffect((()=>{const e=t.map((e=>{const{sanity:t}=e;return"id"in t?t:null})).filter((e=>!!e)),n=new Set(e.map((e=>e.id)));if(!i.current||!function(e,t){if(e===t)return!0;if(e.size!==t.size)return!1;for(const n of e)if(!t.has(n))return!1;return!0}(n,i.current.nodeIds)||r!==i.current.perspective){const t=Array.from(n).map((t=>{const n=e.find((e=>e.id===t)),{type:r,projectId:i,dataset:o}=n;return i&&o?{_id:t,_type:r,_projectId:i,_dataset:o}:{_id:t,_type:r}}));i.current={nodeIds:n,perspective:r},o(t,r)}}),[t,r,o])}(r,x,b);const D=n.useCallback(((e,t)=>{S&&(S.style.setProperty("--drag-preview-x",`${e}px`),S.style.setProperty("--drag-preview-y",t-window.scrollY+"px"))}),[S]);n.useEffect((()=>{const e=e=>{const t=e.target;if((o.G(t)||o.J(t)&&t.closest("a"))&&e.altKey){e.preventDefault(),e.stopPropagation();const t=new MouseEvent(e.type,{...e,altKey:!1,bubbles:!0,cancelable:!0});e.target?.dispatchEvent(t)}},t=e=>{de(e)&&C((e=>!e))},n=e=>{var t;de(e)&&C((e=>!e)),t=e,["mod","\\"].every((e=>le[e]?t[le[e]]:t.key===e.toUpperCase()))&&C((e=>!e))};return window.addEventListener("click",e),window.addEventListener("keydown",n),window.addEventListener("keyup",t),()=>{window.removeEventListener("click",e),window.removeEventListener("keydown",n),window.removeEventListener("keyup",t)}}),[C]);const[T,R]=n.useState(!1),[A,_]=n.useState(!1),z=n.useRef(void 0);n.useEffect((()=>{if(P)return oe((()=>{R(!0),oe((()=>{_(!0),z.current=setTimeout((()=>{_(!1),R(!1)}),1500)}))}));z.current&&(clearTimeout(z.current),R(!1),_(!1))}),[P]);const q=n.useMemo((()=>x.flatMap((e=>"id"in e.sanity?[e.sanity.id]:[]))),[x]),F=n.useCallback((()=>{M({type:"overlay/blur"})}),[]),U=s.h(),O=n.useMemo((()=>U?i:void 0),[i,U]),W=n.useMemo((()=>(c||l)&&"connected"!==u||w?[]:x.filter((e=>e.activated||e.focused)).map((({id:t,element:n,focused:r,hovered:i,rect:o,sanity:s,dragDisabled:l})=>{const d=!l&&!!n.getAttribute("data-sanity")&&U&&x.some((e=>"id"in e.sanity&&"id"in s&&a.s(e.sanity,s)&&e.sanity.path!==s.path));/* @__PURE__ */
return e.jsx(V,{componentResolver:O,element:n,enableScrollIntoView:!w&&!j&&!g,focused:r,hovered:i,node:s,rect:o,showActions:!c,draggable:d,isDragging:w||j,wasMaybeCollapsed:r&&E},t)}))),[O,j,g,x,c,l,w,U,u,E]);/* @__PURE__ */
return e.jsx(re,{comlink:r,children:/* @__PURE__ */e.jsx(o.x,{scheme:f?"dark":"light",theme:o.y,tone:"transparent",children:/* @__PURE__ */e.jsx(o.L,{children:/* @__PURE__ */e.jsx(o.z,{element:S,children:/* @__PURE__ */e.jsx(ee,{comlink:r,elements:x,children:/* @__PURE__ */e.jsx(X,{comlink:r,children:/* @__PURE__ */e.jsx(ne,{comlink:r,children:/* @__PURE__ */e.jsxs(ie,{"data-fading-out":A?"":void 0,"data-overlays":T?"":void 0,ref:I,$zIndex:d,children:[
/* @__PURE__ */e.jsx(se,{documentIds:q,perspective:b}),
/* @__PURE__ */e.jsx(ae,{comlink:r,dispatch:M,inFrame:c,inPopUp:l,onDrag:D,overlayEnabled:P,rootElement:S}),m&&/* @__PURE__ */e.jsx($,{...m,onDismiss:F}),W,w&&!j&&/* @__PURE__ */e.jsxs(e.Fragment,{children:[h&&/* @__PURE__ */e.jsx(N,{dragInsertPosition:h}),v&&/* @__PURE__ */e.jsx(B,{}),k&&/* @__PURE__ */e.jsx(L,{dragGroupRect:k})]}),w&&y&&/* @__PURE__ */e.jsx(G,{skeleton:y})]})})})})})})})})},le={alt:"altKey",ctrl:"ctrlKey",mod:typeof window<"u"&&/Mac|iPod|iPhone|iPad/.test(window.navigator.platform)?"metaKey":"ctrlKey",shift:"shiftKey"};function de(e){return"Alt"===e.key}const ue=e=>{const{comlink:t,refresh:r}=e,i=n.useRef(0),o=n.useRef(0);return n.useEffect((()=>t.on("presentation/refresh",(e=>{if("manual"===e.source){clearTimeout(i.current);const n=r(e);if(!1===n)return;t.post("visual-editing/refreshing",e);let o=!1;i.current=window.setTimeout((()=>{t.post("visual-editing/refreshed",e),o=!0}),3e3),n?.finally?.((()=>{o||(clearTimeout(i.current),t.post("visual-editing/refreshed",e))}))}else if("mutation"===e.source){clearTimeout(o.current);const n=r(e);if(!1===n)return;t.post("visual-editing/refreshing",e),o.current=window.setTimeout((()=>{const n=r(e);!1!==n&&(t.post("visual-editing/refreshing",e),n?.finally?.((()=>{t.post("visual-editing/refreshed",e)}))||t.post("visual-editing/refreshed",e))}),1e3),n?.finally?.((()=>{t.post("visual-editing/refreshed",e)}))||t.post("visual-editing/refreshed",e)}}))),[t,r]),null},pe=i=>{const{components:o,history:s,portal:a=!0,refresh:c,zIndex:l}=i,[d,h]=n.useState(null),[g,x]=n.useState(null);n.useEffect((()=>{h(t.isMaybePreviewIframe()),x(t.isMaybePreviewWindow())}),[]);const[w,b]=n.useState(null);n.useEffect((()=>{if(!1===a)return;const e=document.createElement("sanity-visual-editing");return document.documentElement.appendChild(e),b(e),()=>{b(null),document.documentElement.contains(e)&&document.documentElement.removeChild(e)}}),[a]);const E=function(e=!0){const[r,i]=n.useState();return n.useEffect((()=>{if(!e)return;const n=u.createNode({name:"visual-editing",connectTo:"presentation"},u.createNodeMachine().provide({actors:t.createCompatibilityActors()}));i(n);const r=n.start();return()=>{r(),i(void 0)}}),[e]),r}(!0===d||!0===g);!function(e){n.useEffect((()=>{if(!e)return;const t=function(e){const t=new m.ReplaySubject(1),n=new m.Subject;return e.fetch("visual-editing/snapshot-welcome",void 0,{suppressWarnings:!0}).then((e=>{t.next(e.event)})).catch((()=>{})),e.on("presentation/snapshot-event",(e=>{"reconnect"===e.event.type&&t.next(e.event),"mutation"===e.event.type&&n.next(e.event)})),m.merge(t,n)}(e),n=f.createDatasetMutator(e),r=p.createActor(n,{input:{client:{withConfig:()=>{}},sharedListener:t}});r.start();const i=new AbortController,o=e.onStatus((()=>{e.fetch("visual-editing/features",void 0,{signal:i.signal,suppressWarnings:!0}).then((e=>{e.features.optimistic&&f.setActor(r)})).catch((()=>{console.warn("[@sanity/visual-editing] Package version mismatch detected: Please update your Sanity studio to prevent potential compatibility issues.")}))}),"connected");return()=>{r.stop(),i.abort(),o()}}),[e])}(E);const j=/* @__PURE__ */e.jsxs(e.Fragment,{children:[null!==d&&null!==g&&/* @__PURE__ */e.jsx(ce,{comlink:E,componentResolver:o,inFrame:d,inPopUp:g,zIndex:l}),E&&/* @__PURE__ */e.jsxs(e.Fragment,{children:[
/* @__PURE__ */e.jsx(v,{comlink:E,history:s}),
/* @__PURE__ */e.jsx(y,{comlink:E}),c&&/* @__PURE__ */e.jsx(ue,{comlink:E,refresh:c})]})]});return!1!==a&&w?r.createPortal(j,w):j};pe.displayName="VisualEditing",exports.useDocuments=s.u,exports.useOptimisticActor=s.b,exports.useOptimistic=a.u,Object.defineProperty(exports,"createDataAttribute",{enumerable:!0,get:function(){return l.createDataAttribute}}),exports.createDatasetMutator=f.createDatasetMutator,exports.createDocumentMutator=f.createDocumentMutator,exports.emptyActor=f.emptyActor,exports.VisualEditing=pe;//# sourceMappingURL=index.cjs.map
