import{jsx as e,jsxs as t,Fragment as n}from"react/jsx-runtime";import{createCompatibilityActors as r,isMaybePreviewIframe as i,isMaybePreviewWindow as o}from"@sanity/presentation-comlink";import{useEffect as a,useCallback as s,createContext as c,useContext as l,useState as d,useMemo as p,memo as u,useRef as m,useSyncExternalStore as h,isValidElement as f,useReducer as g}from"react";import{createPortal as v}from"react-dom";import{createEditUrl as y,studioPath as w,getDraftId as b,getPublishedId as x}from"@sanity/client/csm";import{a as k,b as E,g as M,C as I,R as S,S as P,M as $,c as C,e as T,f as D,h as z,U as _,i as R,j as A,k as j,F as V,l as L,T as U,m as F,n as O,o as W,u as G,p as N,d as K,q,D as B,P as Y,r as H,s as X,t as J,H as Z,E as Q,v as ee,w as te,x as ne,y as re,L as ie,z as oe,G as ae,J as se}from"../_chunks-es/PointerEvents.js";import{u as ce,g as le,c as de,a as pe,d as ue,e as me,f as he,h as fe,b as ge}from"../_chunks-es/mutations.js";import{S as ve,c as ye,s as we}from"../_chunks-es/SharedStateContext.js";import{u as be}from"../_chunks-es/SharedStateContext.js";import{at as xe,remove as ke,insert as Ee}from"@sanity/mutate";import{pathToUrlString as Me}from"@sanity/visual-editing-csm";import{createDataAttribute as Ie}from"@sanity/visual-editing-csm";import Se from"scroll-into-view-if-needed";import{createNode as Pe,createNodeMachine as $e}from"@sanity/comlink";import{createActor as Ce}from"xstate";import{createDatasetMutator as Te,setActor as De}from"../optimistic/index.js";import{createDocumentMutator as ze,emptyActor as _e}from"../optimistic/index.js";import{ReplaySubject as Re,Subject as Ae,merge as je}from"rxjs";const Ve=e=>{const{comlink:t,history:n}=e;return a((()=>t?.on("presentation/navigate",(e=>{n?.update(e)}))),[t,n]),a((()=>{if(n)return n.subscribe((e=>{e.title=e.title||document.title,t?.post("visual-editing/navigate",e)}))}),[t,n]),null},Le=e=>{const{comlink:t}=e;return a((()=>{const e=()=>{t.post("visual-editing/meta",{title:document.title})},n=new MutationObserver((([t])=>{"TITLE"===t.target.nodeName&&e()}));return n.observe(document.head,{subtree:!0,characterData:!0,childList:!0}),e(),()=>n.disconnect()}),[t]),null},Ue=c(null);function Fe(){const e=l(Ue);if(!e)throw new Error("Schema context is missing");return e}function Oe(e,t){if(!e.type)throw new Error("Node type is missing");return()=>t.patch((async({getSnapshot:t})=>me(e,await t())))}function We(e,t,n,r){if(!e.type)throw new Error("Node type is missing");return()=>t.patch((()=>pe(e,n,r)))}function Ge(e,t){if(!e.type)throw new Error("Node type is missing");return()=>t.patch((async({getSnapshot:t})=>he(e,await t())))}function Ne(e){const{node:t,doc:n}=e;return n?[{type:"action",label:"Duplicate",icon:I,action:Ge(t,n),telemetryEvent:"Visual Editing Context Menu Item Duplicated"}]:[]}function Ke(e){const{node:t,doc:n}=e;return n?[{type:"action",label:"Remove",icon:S,action:Oe(t,n),telemetryEvent:"Visual Editing Context Menu Item Removed"}]:[]}async function qe(e,t=!0){const{node:n,doc:r}=e;if(!r)return[];const i=[],o=[],[a,s,c,l]=await Promise.all([ue(n,r,"previous"),ue(n,r,"next"),ue(n,r,"first"),ue(n,r,"last")]);return c.length&&o.push({type:"action",label:"To top",icon:T,action:()=>r.patch(c),telemetryEvent:"Visual Editing Context Menu Item Moved"}),a.length&&o.push({type:"action",label:"Up",icon:D,action:()=>r.patch(a),telemetryEvent:"Visual Editing Context Menu Item Moved"}),s.length&&o.push({type:"action",label:"Down",icon:z,action:()=>r.patch(s),telemetryEvent:"Visual Editing Context Menu Item Moved"}),l.length&&o.push({type:"action",label:"To bottom",icon:_,action:()=>r.patch(l),telemetryEvent:"Visual Editing Context Menu Item Moved"}),o.length&&(i.push({type:"group",label:"Move",icon:P,items:o}),t&&i.push({type:"divider"})),i}const Be=t=>{const{label:n,parent:r,width:i,onSelect:o,boundaryElement:a}=t;/* @__PURE__ */
return e($,{fontSize:1,icon:E,padding:2,popover:{arrow:!1,constrainSize:!0,floatingBoundary:a,padding:0,placement:"right-start",fallbackPlacements:["left-start","right","left","right-end","left-end","bottom","top"],preventOverflow:!0,width:i,__unstable_margins:[4,4,4,4]},space:2,text:n,children:/* @__PURE__ */e(C,{node:r,onSelect:o})})},Ye=[-4,4,-4,4];function He(t){const{node:n,onDismiss:r,boundaryElement:i}=t,o=G(),a=s((()=>{"action"===n.type&&(n.action?.(),r?.(),n.telemetryEvent&&o(n.telemetryEvent,null))}),[n,r,o]);if("divider"===n.type)/* @__PURE__ */
return e(W,{});if("action"===n.type)/* @__PURE__ */
return e(N,{fontSize:1,hotkeys:n.hotkeys,icon:n.icon,padding:2,space:2,text:n.label,disabled:!n.action,onClick:a});if("group"===n.type)/* @__PURE__ */
return e($,{fontSize:1,icon:n.icon,padding:2,popover:{arrow:!1,constrainSize:!0,placement:"right-start",fallbackPlacements:["left-start","right","left","right-end","left-end","bottom","top"],preventOverflow:!0,__unstable_margins:Ye},space:2,text:n.label,children:n.items.map(((t,n)=>/* @__PURE__ */e(He,{node:t,onDismiss:r,boundaryElement:i},n)))});if("custom"===n.type){const{component:t}=n;/* @__PURE__ */
return e(t,{boundaryElement:i,sendTelemetry:o})}return null}const Xe=r=>{const{node:i,onDismiss:o,position:{x:s,y:c}}=r,[l,u]=d(null),{getField:m}=Fe(),{getDocument:h}=ce(),{field:f,parent:g}=m(i),v=p((()=>f?.title||f?.name||"Unknown type"),[f]),[y,w]=d(void 0);a((()=>{(async()=>{const t=h(i.id);if(!t)return;const n=await function(t){const{node:n,field:r,parent:i,doc:o}=t;return"arrayItem"===r?.type?async function(e){const{node:t,field:n,doc:r}=e,i=[];return i.push(...Ne(e)),i.push(...Ke(e)),i.push(...await qe(e)),i.push({type:"action",label:"Insert before",icon:k,action:We(t,r,n.name,"before"),telemetryEvent:"Visual Editing Context Menu Item Inserted"}),i.push({type:"action",label:"Insert after",icon:E,action:We(t,r,n.name,"after"),telemetryEvent:"Visual Editing Context Menu Item Inserted"}),i}({node:n,field:r,doc:o}):"union"===i?.type?async function(t){const{doc:n,node:r,parent:i}=t,o=[];if(o.push(...Ne(t)),o.push(...Ke(t)),o.push(...await qe(t)),i.options?.insertMenu){const t=(i.options.insertMenu||{}).views?.some((e=>"grid"===e.name))?0:void 0;o.push({type:"custom",component:({boundaryElement:o,sendTelemetry:a})=>/* @__PURE__ */e(Be,{label:"Insert before",onSelect:e=>{We(r,n,e.name,"before")(),a("Visual Editing Context Menu Item Inserted",null)},parent:i,width:t,boundaryElement:o})}),o.push({type:"custom",component:({boundaryElement:o,sendTelemetry:a})=>/* @__PURE__ */e(Be,{label:"Insert after",onSelect:e=>{We(r,n,e.name,"after")(),a("Visual Editing Context Menu Item Inserted",null)},parent:i,width:t,boundaryElement:o})})}else o.push({type:"group",label:"Insert before",icon:k,items:i.of.filter((e=>"unionOption"===e.type)).map((e=>({type:"action",icon:M(e),label:"block"===e.name?"Paragraph":e.title||e.name,action:We(r,n,e.name,"before"),telemetryEvent:"Visual Editing Context Menu Item Inserted"})))}),o.push({type:"group",label:"Insert after",icon:E,items:i.of.filter((e=>"unionOption"===e.type)).map((e=>({type:"action",label:"block"===e.name?"Paragraph":e.title||e.name,icon:M(e),action:We(r,n,e.name,"after"),telemetryEvent:"Visual Editing Context Menu Item Inserted"})))});return o}({node:n,parent:i,doc:o}):Promise.resolve([])}({node:i,field:f,parent:g,doc:t});w(n)})()}),[f,i,g,h]);const b=p((()=>({getBoundingClientRect:()=>({bottom:c,left:s,right:s,top:c,width:0,height:0})})),[s,c]),x=p((()=>M(f)),[f]);/* @__PURE__ */
return e(R,{setBoundaryElement:u,onDismiss:o,children:/* @__PURE__ */e(A,{__unstable_margins:Ye,arrow:!1,open:!0,placement:"right-start",referenceElement:b,content:/* @__PURE__ */t(j,{style:{minWidth:120,maxWidth:160},children:[
/* @__PURE__ */t(V,{gap:2,padding:2,children:[
/* @__PURE__ */e(L,{flex:"none",children:y?/* @__PURE__ */e(U,{size:1,children:x}):/* @__PURE__ */e(F,{size:1})}),
/* @__PURE__ */e(O,{flex:1,space:2,children:/* @__PURE__ */e(U,{size:1,weight:"semibold",children:y?v:"Loading..."})})]}),y&&/* @__PURE__ */t(n,{children:[
/* @__PURE__ */e(W,{}),y.map(((t,n)=>/* @__PURE__ */e(He,{node:t,onDismiss:o,boundaryElement:l},n)))]})]}),children:/* @__PURE__ */e("div",{style:{position:"absolute",left:s,top:c}},`${s}-${c}`)})})};function Je(e,t){try{const n=new URL(e,typeof location>"u"?void 0:location.origin);if(n.hash){const e=new URL(Je(n.hash.slice(1),t));return`${n.origin}${n.pathname}${n.search}#${e.pathname}${e.search}`}return n.searchParams.set("preview",t),n.toString()}catch{return e}}const Ze=c(null),Qe=K(q)`
  background-color: var(--overlay-bg);
  border-radius: 3px;
  pointer-events: none;
  position: absolute;
  will-change: transform;
  box-shadow: var(--overlay-box-shadow);
  transition: none;

  --overlay-bg: transparent;
  --overlay-box-shadow: inset 0 0 0 1px transparent;

  [data-overlays] & {
    --overlay-bg: color-mix(in srgb, transparent 95%, var(--card-focus-ring-color));
    --overlay-box-shadow: inset 0 0 0 2px
      color-mix(in srgb, transparent 50%, var(--card-focus-ring-color));
  }

  [data-fading-out] & {
    transition:
      box-shadow 1550ms,
      background-color 1550ms;

    --overlay-bg: rgba(0, 0, 255, 0);
    --overlay-box-shadow: inset 0 0 0 1px transparent;
  }

  &[data-focused] {
    --overlay-box-shadow: inset 0 0 0 1px var(--card-focus-ring-color);
  }

  &[data-hovered]:not([data-focused]) {
    transition: none;
    --overlay-box-shadow: inset 0 0 0 2px var(--card-focus-ring-color);
  }

  /* [data-unmounted] & {
    --overlay-box-shadow: inset 0 0 0 1px var(--card-focus-ring-color);
  } */

  :link {
    text-decoration: none;
  }
`,et=K(V)`
  bottom: 100%;
  cursor: pointer;
  pointer-events: none;
  position: absolute;
  right: 0;

  [data-hovered] & {
    pointer-events: all;
  }

  [data-flipped] & {
    bottom: auto;
    top: 100%;
  }
`,tt=K(V)`
  bottom: 100%;
  cursor: pointer;
  pointer-events: none;
  position: absolute;
  left: 0;

  [data-hovered] & {
    pointer-events: all;
  }

  [data-flipped] & {
    bottom: auto;
    top: 100%;
  }
`,nt=K(q)`
  cursor: pointer;
  background-color: var(--card-focus-ring-color);
  right: 0;
  border-radius: 3px;

  & [data-ui='Text'] {
    color: #fff;
    white-space: nowrap;
  }
`,rt=K(V)`
  display: flex;
  align-items: center;
  background-color: var(--card-focus-ring-color);
  right: 0;
  border-radius: 3px;
  & [data-ui='Text'],
  & [data-sanity-icon] {
    color: #fff;
    white-space: nowrap;
  }
`,it=r=>{const{element:i,focused:o,componentResolver:a,node:s,showActions:c,draggable:d}=r,{getField:u,getType:m}=Fe(),h=m(s),{field:g,parent:v}=u(s),b="path"in s?function(e){const{id:t,type:n,path:r,baseUrl:i,tool:o,workspace:a}=e;return y({baseUrl:i,workspace:a,tool:o,type:n,id:t,path:Me(w.fromString(r))})}(s):s.href,x=function(){const e=l(Ze);if(!e)throw new Error("Preview Snapshots context is missing");return e}(),k=p((()=>{if("path"in s)return x.find((e=>e._id===s.id))?.title}),[s,x]),E=p((()=>{if(!("path"in s)||!g||!h)return;const e=g.value.type;return{document:h,element:i,field:g,focused:!!o,node:s,parent:v,type:e}}),[h,i,g,o,s,v]),M=function(e,t){return p((()=>{if(!e)return;const n=t?.(e);return n?f(n)?n:(Array.isArray(n)?n:[n]).map((e=>"object"==typeof e&&"component"in e?e:{component:e,props:{}})):void 0}),[t,e])}(E,a),I=h?.icon?/* @__PURE__ */e("div",{dangerouslySetInnerHTML:{__html:h.icon}}):/* @__PURE__ */e(H,{});/* @__PURE__ */
return t(n,{children:[c?/* @__PURE__ */e(et,{gap:1,paddingY:1,"data-sanity-overlay-element":!0,children:/* @__PURE__ */e(at,{href:b})}):null,k&&/* @__PURE__ */e(tt,{gap:1,paddingY:1,children:/* @__PURE__ */t(rt,{gap:2,padding:2,children:[d&&/* @__PURE__ */e(L,{marginRight:1,children:/* @__PURE__ */e(U,{className:"drag-handle",size:0,children:/* @__PURE__ */e(B,{})})}),
/* @__PURE__ */e(U,{size:0,children:I}),
/* @__PURE__ */e(U,{size:1,weight:"medium",children:k})]})}),Array.isArray(M)?M.map((({component:t,props:n},r)=>/* @__PURE__ */e(t,{PointerEvents:Y,...E,...n},r))):M]})},ot=u((function(t){const{draggable:n,focused:r,hovered:i,rect:o,wasMaybeCollapsed:s,enableScrollIntoView:c}=t,l=m(null),u=m(!1),h=p((()=>({width:`${o.w}px`,height:`${o.h}px`,transform:`translate(${o.x}px, ${o.y}px)`})),[o]);a((()=>{if(!u.current&&!s&&!0===r&&l.current&&c){const e=l.current;Se(l.current,{behavior:t=>{0!==t.length&&e.scrollIntoView({behavior:"smooth",block:"center",inline:"nearest"})},scrollMode:"if-needed",block:"center",inline:"nearest"})}u.current=!0===r}),[r,s,c]);const[f,g]=d(!1);return a((()=>{if(!l.current||!i)return;const e=new IntersectionObserver((([e])=>{g(e.boundingClientRect.top<0)}),{threshold:1});return e.observe(l.current),()=>e.disconnect()}),[i,f]),/* @__PURE__ */e(Qe,{"data-focused":r?"":void 0,"data-hovered":i?"":void 0,"data-flipped":f?"":void 0,"data-draggable":n?"":void 0,ref:l,style:h,children:i&&/* @__PURE__ */e(it,{...t})})})),at=u((function(t){const n=h(s((e=>{const t=()=>e();return window.addEventListener("popstate",t),()=>window.removeEventListener("popstate",t)}),[]),(()=>window.location.href)),r=p((()=>Je(t.href,n)),[t.href,n]);/* @__PURE__ */
return e(L,{as:"a",href:r,target:"_blank",rel:"noopener noreferrer",children:/* @__PURE__ */e(nt,{padding:2,children:/* @__PURE__ */e(U,{size:1,weight:"medium",children:"Open in Studio"})})})})),st=({dragGroupRect:t})=>/* @__PURE__ */e("div",{style:{position:"absolute",top:`${t.y}px`,left:`${t.x}px`,width:t.w-1+"px",height:t.h-1+"px",border:"1px dashed #f0709b",pointerEvents:"none"}});function ct(e,t,n){return e*(1-n)+t*n}const lt=({dragInsertPosition:t})=>{if(null===t)return;let n=0,r=0,i=0,o=0;const a=.0125;if("horizontal"==(t?.left||t?.right?"horizontal":"vertical")){const{left:e,right:s}=t;if(i=6,s&&e){const t=e.rect.x+e.rect.w,i=s.rect.x,c=Math.min(s.rect.h,e.rect.h)*a;n=ct(t,i,.5)-3,r=e.rect.y+c,o=Math.min(s.rect.h,e.rect.h)-2*c}else if(s&&!e){const e=s.rect.h*a;n=s.rect.x-3,r=s.rect.y+e,o=s.rect.h-2*e}else if(e&&!s){const t=e.rect.h*a;n=e.rect.x+e.rect.w-3,r=e.rect.y+t,o=e.rect.h-2*t}}else{const{bottom:e,top:s}=t;if(e&&s){const t=Math.min(s.rect.x,e.rect.x),c=s.rect.y+s.rect.h,l=e.rect.y,d=Math.min(e.rect.w,s.rect.w)*a;o=6,n=t+d,r=ct(c,l,.5)-3,i=Math.max(e.rect.w,s.rect.w)-2*d}else if(e&&!s){const t=e.rect.w*a;n=e.rect.x+t,r=e.rect.y-3,i=e.rect.w-2*t,o=6}else if(s&&!e){const e=s.rect.w*a;n=s.rect.x+e,r=s.rect.y+s.rect.h-3,i=s.rect.w-2*e,o=6}}/* @__PURE__ */
return e("div",{style:{position:"absolute",width:`${i}px`,height:`${o}px`,transform:`translate(${n}px, ${r}px)`,background:"#556bfc",border:"2px solid white",borderRadius:"999px",zIndex:"999999"}})},dt=K.div`
  --drag-preview-opacity: 0.98;
  --drag-preview-skeleton-stroke: #ffffff;

  @media (prefers-color-scheme: dark) {
    --drag-preview-skeleton-stroke: #383d51;
  }

  position: fixed;
  display: grid;
  transform: ${({$scaleFactor:e,$width:t,$height:n})=>`translate(calc(var(--drag-preview-x) - ${t/2}px), calc(var(--drag-preview-y) - ${n/2}px)) scale(${e})`};
  width: ${({$width:e})=>`${e}px`};
  height: ${({$height:e})=>`${e}px`};
  z-index: 9999999;
  opacity: var(--drag-preview-opacity);
  cursor: move;

  .drag-preview-content-wrapper {
    position: relative;
    width: 100%;
    height: 100%;
    container-type: inline-size;
  }

  [data-ui='card'] {
    position: relative;
    width: 100%;
    height: 100%;
  }

  .drag-preview-skeleton {
    position: absolute;
    inset: 0;

    rect {
      stroke: var(--drag-preview-skeleton-stroke);
    }
  }

  .drag-preview-handle {
    position: absolute;
    top: 4cqmin;
    left: 4cqmin;
    width: 6cqmin;
    fill: var(--drag-preview-handle-fill);
  }
`,pt=({skeleton:t})=>{const n=Math.min(t.maxWidth,window.innerWidth/2),r=t.w>n?n/t.w:1,i=t.offsetX*r,o=t.offsetY*r,a=X(),s=J(),c=s.radius[(p=t.w,u=s.radius.length-2,~~function(e,t,n){return e<1?1:e>n?n:e}((p-0)*(u-1)/1920+1,0,u))],l=t.childRects.filter((e=>"IMG"===e.tagName)),d=t.childRects.filter((e=>"IMG"!==e.tagName));var p,u;/* @__PURE__ */
return e(dt,{$width:t.w,$height:t.h,$offsetX:i,$offsetY:o,$scaleFactor:r,children:/* @__PURE__ */e(q,{radius:c,shadow:4,overflow:"hidden",tone:"transparent",scheme:a?"dark":"light",children:/* @__PURE__ */e("div",{className:"drag-preview-content-wrapper",children:/* @__PURE__ */e("svg",{className:"drag-preview-skeleton",viewBox:`0 0 ${t.w} ${t.h}`,children:[...l,...d].map(((t,n)=>/* @__PURE__ */e("rect",{x:t.x,y:t.y,width:t.w,height:t.h,fill:s.color.skeleton.from},n)))})})})})},ut=K(q)`
  position: fixed;
  bottom: 2rem;
  left: 2rem;
`,mt=()=>/* @__PURE__ */e(ut,{padding:2,shadow:2,radius:2,style:{zIndex:"999999"},children:/* @__PURE__ */t(V,{align:"center",gap:2,children:[
/* @__PURE__ */e(Z,{keys:["Shift"]}),
/* @__PURE__ */e(U,{size:1,children:"Zoom Out"}),
/* @__PURE__ */e(Q,{})]})}),ht=(e,t)=>{const{type:n}=t;switch(n){case"element/register":return e.find((e=>e.id===t.id))?e:[...e,{id:t.id,activated:!1,element:t.element,focused:!1,hovered:!1,rect:t.rect,sanity:t.sanity,dragDisabled:t.dragDisabled}];case"element/activate":return e.map((e=>e.id===t.id?{...e,activated:!0}:e));case"element/update":return e.map((e=>e.id===t.id?{...e,sanity:t.sanity,rect:t.rect}:e));case"element/unregister":return e.filter((e=>e.id!==t.id));case"element/deactivate":return e.map((e=>e.id===t.id?{...e,activated:!1,hovered:!1}:e));case"element/mouseenter":return e.map((e=>e.id===t.id?{...e,rect:t.rect,hovered:!0}:{...e,hovered:!1}));case"element/mouseleave":return e.map((e=>e.id===t.id?{...e,hovered:!1}:e));case"element/updateRect":return e.map((e=>e.id===t.id?{...e,rect:t.rect}:e));case"element/click":return e.map((e=>({...e,focused:e.id===t.id&&"clicked"})));case"overlay/blur":case"presentation/blur":return e.map((e=>({...e,focused:!1})));case"presentation/focus":{const n=e.find((e=>"clicked"===e.focused));return e.map((e=>{const r="path"in e.sanity&&e.sanity.id===t.data.id&&e.sanity.path===t.data.path;return n&&e===n&&r?e:{...e,focused:r&&n?"duplicate":r}}))}default:return e}};function ft(e,t){const{type:n}=t;let{contextMenu:r,focusPath:i,perspective:o,isDragging:a,dragInsertPosition:s,dragShowMinimap:c,dragShowMinimapPrompt:l,dragSkeleton:d,dragMinimapTransition:p,dragGroupRect:u}=e,m=!1;if("presentation/focus"===n){const n=e.focusPath;i=t.data.path,n!==i&&(m=n.slice(i.length).startsWith("["))}return"presentation/perspective"===n&&(o=t.data.perspective),"element/contextmenu"===n&&(r="sanity"in t?{node:t.sanity,position:t.position}:null),("element/click"===n||"element/mouseleave"===n||"overlay/blur"===n||"presentation/blur"===n||"presentation/focus"===n)&&(r=null),"overlay/dragUpdateInsertPosition"===n&&(s=t.insertPosition),"overlay/dragStart"===n&&(a=!0),"overlay/dragUpdateSkeleton"===t.type&&(d=t.skeleton),"overlay/dragEnd"===n&&(a=!1),"overlay/dragToggleMinimapPrompt"===t.type&&(l=t.display),"overlay/dragStartMinimapTransition"===n&&(p=!0),"overlay/dragEndMinimapTransition"===n&&(p=!1),"overlay/dragUpdateGroupRect"===n&&(u=t.groupRect),"overlay/dragToggleMinimap"===n&&(c=t.display),{...e,contextMenu:r,elements:ht(e.elements,t),dragInsertPosition:s,dragSkeleton:d,dragGroupRect:u,isDragging:a,focusPath:i,perspective:o,wasMaybeCollapsed:m,dragShowMinimap:c,dragShowMinimapPrompt:l,dragMinimapTransition:p}}const gt=function(t){const{comlink:n,children:r}=t,[i,o]=d([]),c=s((async e=>{if(n)try{const t=await n.fetch("visual-editing/preview-snapshots",void 0,{signal:e,suppressWarnings:!0});o(t.snapshots)}catch{}}),[n]);a((()=>{if(!n)return;const e=new AbortController,t=n.onStatus((()=>{c(e.signal)}),"connected");return()=>{e.abort(),t()}}),[n,c]),a((()=>n?.on("presentation/preview-snapshots",(e=>{o(e.snapshots)}))),[n]);const l=p((()=>i),[i]);/* @__PURE__ */
return e(Ze.Provider,{value:l,children:r})};function vt(e){return"path"in e}function yt(e){return"document"===e.type}function wt(e){return"type"===e.type}const bt=function(t){const{comlink:n,children:r,elements:i}=t,[o,c]=d(/* @__PURE__ */new Map),[l,u]=d(null),h=s((async e=>{if(n)try{const t=await n.fetch("visual-editing/schema",void 0,{signal:e,suppressWarnings:!0});u(t.schema)}catch{}}),[n]);a((()=>{if(!n)return;const e=new AbortController,t=n.onStatus((()=>{h(e.signal)}),"connected");return()=>{e.abort(),t()}}),[n,h]);const f=m([]);a((()=>{const e=new AbortController,t=function(e){return e.reduce(((e,t)=>{const{sanity:n}=t;if(!("id"in n)||!n.path.includes("[_key=="))return e;const r=function(e){return e.split(".").toReversed().reduce(((e,t)=>e.length?[t,...e]:t.includes("[_key==")?[t]:[]),[]).join(".")}(n.path);return e.find((e=>e.id===n.id&&e.path===r))||e.push({id:n.id,path:r}),e}),[])}(i);return t.some((e=>!f.current.find((({id:t,path:n})=>t===e.id&&n===e.path))))&&(async(e,t)=>{if(e.length&&n)try{const r=await n.fetch("visual-editing/schema-union-types",{paths:e},{signal:t,suppressWarnings:!0});c(r.types),f.current=e}catch{}})(t,e.signal),()=>e.abort()}),[n,i]);const g=s(((e,t)=>{const n=t||"document";if(!l||"string"!=typeof e&&(!vt(e)||!Array.isArray(l)))return;const r="string"==typeof e?e:e.type,i="document"===n?yt:wt;return l.filter(i).find((e=>e.name===r))}),[l]),v=s((e=>{if(!vt(e))return{field:void 0,parent:void 0};const t=g(e);if(!t)return{field:void 0,parent:void 0};const n=e.path.split(".").flatMap((e=>e.includes("[")?e.split(/(\[.+\])/,2):[e]));try{return function t(n,r,i,a=[]){if(!n)return{field:void 0,parent:void 0};const[s,...c]=r;if("fields"in n){const e=n.fields[s];if(!e&&"rest"in n)return t(n.rest,r,n,a);if(!c.length)return{field:e,parent:i};if(!e)throw new Error(`[@sanity/visual-editing] No field could be resolved at path: "${[...a,...r].join(".")}"`);return t(e.value,c,n,[...a,s])}if("array"===n.type)return t(n.of,r,n,a);if("arrayItem"===n.type)return c.length?t(n.value,c,n,[...a,s]):{field:n,parent:i};if("union"===n.type){const r=s.startsWith("[_key==")?o?.get(e.id)?.get([a.join("."),s].filter(Boolean).join("")):s;return t(n.of.find((e=>"unionOption"===e.type?e.name===r:e)),c,n,[...a,s])}if("unionOption"===n.type)return s?t(n.value,r,n,a):{field:n,parent:i};if("inline"===n.type)return t(g(n.name,"type").value,r,n,a);throw new Error(`[@sanity/visual-editing] No field could be resolved at path: "${[...a,...r].join(".")}"`)}(t,n,void 0)}catch(e){return e instanceof Error&&console.warn(e.message),{field:void 0,parent:void 0}}}),[g,o]),y=p((()=>({getField:v,getType:g,resolvedTypes:o,schema:l||[]})),[v,g,o,l]);/* @__PURE__ */
return e(Ue.Provider,{value:y,children:r})},xt=(()=>{let e={};const t=/* @__PURE__ */new Set;return{getState:()=>e,setState:n=>{e=n(e),t.forEach((e=>e()))},subscribe:e=>(t.add(e),()=>t.delete(e))}})(),kt=t=>{const{comlink:n,children:r}=t;a((()=>n?.on("presentation/shared-state",(e=>{"value"in e?xt.setState((t=>({...t,[e.key]:e.value}))):xt.setState((t=>Object.fromEntries(Object.entries(t).filter((([t])=>t!==e.key)))))}))),[n]),a((()=>{(async function(){const e=await(n?.fetch("visual-editing/shared-state",void 0,{suppressWarnings:!0}));e&&xt.setState((()=>e.state))})().catch((e=>{console.debug(e),console.warn("[@sanity/visual-editing]: Failed to fetch shared state. Check your version of `sanity` is up-to-date")}))}),[n]);const i=p((()=>({comlink:n,store:xt})),[n]);/* @__PURE__ */
return e(ve.Provider,{value:i,children:r})},Et=({children:t,comlink:n})=>{const r=s(((e,t)=>{if(!n)return;const r=te[e];if(!r)throw new Error(`Telemetry event: ${e} does not exist`);n.post("visual-editing/telemetry-log",{event:r,data:t})}),[n]);/* @__PURE__ */
return e(ee.Provider,{value:r,children:t})},Mt=K.div`
  background-color: transparent;
  direction: ltr;
  inset: 0;
  pointer-events: none;
  position: absolute;
  width: 100%;
  height: 100%;
  z-index: ${({$zIndex:e})=>e??"9999999"};
`;function It(e){let t,n;return t=requestAnimationFrame((()=>{n=requestAnimationFrame(e)})),()=>{void 0!==t&&cancelAnimationFrame(t),void 0!==n&&cancelAnimationFrame(n)}}const St=e=>{const{documentIds:t}=e,[n,r]=d([]);a((()=>{r((e=>{const n=Array.from(new Set(t));return e.length===n.length&&0===e.reduce(((e,t)=>e.filter((e=>e!==t))),n)?.length?e:n}))}),[t]);const i=ge();return a((()=>{for(const e of n)i.send({type:"observe",documentId:b(e)}),i.send({type:"observe",documentId:x(e)});return()=>{for(const e of n)i.send({type:"unobserve",documentId:b(e)}),i.send({type:"unobserve",documentId:x(e)})}}),[i,n]),null},Pt=e=>{const{comlink:t,dispatch:n,inFrame:r,inPopUp:i,onDrag:o,overlayEnabled:c,rootElement:l}=e,{dispatchDragEndEvent:d}=function(){const{getDocument:e}=ce();return a((()=>{const t=t=>{const{insertPosition:n,target:r,preventInsertDefault:i}=t.detail;if(i)return;const o=function(e){if(e){const{top:t,right:n,bottom:r,left:i}=e;if(i||t)return{node:(i??t).sanity,position:"after"};if(n||r)return{node:(n??r).sanity,position:"before"}}}(n);if(o){const t=e(r.id),{node:n,position:i}=o,{key:a,hasExplicitKey:s}=le(r),{path:c,key:l}=le(n);c&&l&&l!==a&&t.patch((async({getSnapshot:e})=>{const t=await e(),n=de(t,r.path);return s?[xe(c,ke({_key:a})),xe(c,Ee(n,i,{_key:l}))]:[xe(c,ke(~~a)),xe(c,Ee(n,i,l>a?~~l-1:~~l))]}))}};return window.addEventListener("sanity/dragEnd",t),()=>{window.removeEventListener("sanity/dragEnd",t)}}),[e]),{dispatchDragEndEvent:s((e=>{const t=new CustomEvent("sanity/dragEnd",{detail:e,cancelable:!0});window.dispatchEvent(t)}),[])}}(),p=G(),u=function(e,t,n,r){const i=m(void 0),o=fe();return a((()=>{if(e)return i.current=ye({handler:t,overlayElement:e,inFrame:n,inPopUp:r,optimisticActorReady:o}),()=>{i.current?.destroy(),i.current=void 0}}),[e,t,n,r,o]),i}(l,s((e=>{if("element/click"===e.type){const{sanity:n}=e;t?.post("visual-editing/focus",n),p("Visual Editing Overlay Clicked",null)}else if("overlay/activate"===e.type)t?.post("visual-editing/toggle",{enabled:!0});else if("overlay/deactivate"===e.type)t?.post("visual-editing/toggle",{enabled:!1});else if("overlay/dragEnd"===e.type){const{insertPosition:t,target:n,dragGroup:r,flow:i,preventInsertDefault:o}=e;d({insertPosition:t,target:n,dragGroup:r,flow:i,preventInsertDefault:o}),t&&p("Visual Editing Drag Sequence Completed",null)}else{if("overlay/dragUpdateCursorPosition"===e.type)return void o(e.x,e.y);if("overlay/dragToggleMinimap"===e.type&&!0===e.display)p("Visual Editing Drag Minimap Enabled",null);else if("overlay/setCursor"===e.type){const{element:t,cursor:n}=e;n?t.style.cursor=n:t.style.removeProperty("cursor")}}n(e)}),[t,n,d,o,p]),r,i);return a((()=>{c?u.current?.activate():u.current?.deactivate()}),[u,c]),null},$t=r=>{const{comlink:i,componentResolver:o,inFrame:c,inPopUp:l,zIndex:u}=r,[h,f]=d(),v=X(),[{contextMenu:y,dragInsertPosition:w,dragShowMinimap:b,dragShowMinimapPrompt:x,dragSkeleton:k,elements:E,isDragging:M,perspective:I,wasMaybeCollapsed:S,dragMinimapTransition:P,dragGroupRect:$},C]=g(ft,{contextMenu:null,dragInsertPosition:null,dragShowMinimap:!1,dragShowMinimapPrompt:!1,dragSkeleton:null,elements:[],focusPath:"",isDragging:!1,perspective:"published",wasMaybeCollapsed:!1,dragMinimapTransition:!1,dragGroupRect:null}),[T,D]=d(null),[z,_]=d(!0);a((()=>{const e=[i?.on("presentation/focus",(e=>{C({type:"presentation/focus",data:e})})),i?.on("presentation/blur",(e=>{C({type:"presentation/blur",data:e})})),i?.on("presentation/toggle-overlay",(()=>{_((e=>!e))})),i?.onStatus((e=>{f(e)}))].filter(Boolean);return()=>e.forEach((e=>e()))}),[i]),function(e,t){a((()=>{const n=new AbortController;e?.fetch("visual-editing/fetch-perspective",void 0,{signal:n.signal,suppressWarnings:!0}).then((e=>{t({type:"presentation/perspective",data:e})})).catch((()=>{}));const r=e?.on("presentation/perspective",(e=>{t({type:"presentation/perspective",data:e})}));return()=>{r?.(),n.abort()}}),[e,t])}(i,C),function(e,t,n){const r=m(void 0),i=s(((t,n)=>{e?.post("visual-editing/documents",{documents:t,perspective:n})}),[e]);a((()=>{const e=t.map((e=>{const{sanity:t}=e;return"id"in t?t:null})).filter((e=>!!e)),o=new Set(e.map((e=>e.id)));if(!r.current||!function(e,t){if(e===t)return!0;if(e.size!==t.size)return!1;for(const n of e)if(!t.has(n))return!1;return!0}(o,r.current.nodeIds)||n!==r.current.perspective){const t=Array.from(o).map((t=>{const n=e.find((e=>e.id===t)),{type:r,projectId:i,dataset:o}=n;return i&&o?{_id:t,_type:r,_projectId:i,_dataset:o}:{_id:t,_type:r}}));r.current={nodeIds:o,perspective:n},i(t,n)}}),[t,n,i])}(i,E,I);const R=s(((e,t)=>{T&&(T.style.setProperty("--drag-preview-x",`${e}px`),T.style.setProperty("--drag-preview-y",t-window.scrollY+"px"))}),[T]);a((()=>{const e=e=>{const t=e.target;if((ae(t)||se(t)&&t.closest("a"))&&e.altKey){e.preventDefault(),e.stopPropagation();const t=new MouseEvent(e.type,{...e,altKey:!1,bubbles:!0,cancelable:!0});e.target?.dispatchEvent(t)}},t=e=>{Tt(e)&&_((e=>!e))},n=e=>{var t;Tt(e)&&_((e=>!e)),t=e,["mod","\\"].every((e=>Ct[e]?t[Ct[e]]:t.key===e.toUpperCase()))&&_((e=>!e))};return window.addEventListener("click",e),window.addEventListener("keydown",n),window.addEventListener("keyup",t),()=>{window.removeEventListener("click",e),window.removeEventListener("keydown",n),window.removeEventListener("keyup",t)}}),[_]);const[A,j]=d(!1),[V,L]=d(!1),U=m(void 0);a((()=>{if(z)return It((()=>{j(!0),It((()=>{L(!0),U.current=setTimeout((()=>{L(!1),j(!1)}),1500)}))}));U.current&&(clearTimeout(U.current),j(!1),L(!1))}),[z]);const F=p((()=>E.flatMap((e=>"id"in e.sanity?[e.sanity.id]:[]))),[E]),O=s((()=>{C({type:"overlay/blur"})}),[]),W=fe(),G=p((()=>W?o:void 0),[o,W]),N=p((()=>(c||l)&&"connected"!==h||M?[]:E.filter((e=>e.activated||e.focused)).map((({id:t,element:n,focused:r,hovered:i,rect:o,sanity:a,dragDisabled:s})=>{const l=!s&&!!n.getAttribute("data-sanity")&&W&&E.some((e=>"id"in e.sanity&&"id"in a&&we(e.sanity,a)&&e.sanity.path!==a.path));/* @__PURE__ */
return e(ot,{componentResolver:G,element:n,enableScrollIntoView:!M&&!P&&!b,focused:r,hovered:i,node:a,rect:o,showActions:!c,draggable:l,isDragging:M||P,wasMaybeCollapsed:r&&S},t)}))),[G,P,b,E,c,l,M,W,h,S]);/* @__PURE__ */
return e(Et,{comlink:i,children:/* @__PURE__ */e(ne,{scheme:v?"dark":"light",theme:re,tone:"transparent",children:/* @__PURE__ */e(ie,{children:/* @__PURE__ */e(oe,{element:T,children:/* @__PURE__ */e(bt,{comlink:i,elements:E,children:/* @__PURE__ */e(gt,{comlink:i,children:/* @__PURE__ */e(kt,{comlink:i,children:/* @__PURE__ */t(Mt,{"data-fading-out":V?"":void 0,"data-overlays":A?"":void 0,ref:D,$zIndex:u,children:[
/* @__PURE__ */e(St,{documentIds:F,perspective:I}),
/* @__PURE__ */e(Pt,{comlink:i,dispatch:C,inFrame:c,inPopUp:l,onDrag:R,overlayEnabled:z,rootElement:T}),y&&/* @__PURE__ */e(Xe,{...y,onDismiss:O}),N,M&&!P&&/* @__PURE__ */t(n,{children:[w&&/* @__PURE__ */e(lt,{dragInsertPosition:w}),x&&/* @__PURE__ */e(mt,{}),$&&/* @__PURE__ */e(st,{dragGroupRect:$})]}),M&&k&&/* @__PURE__ */e(pt,{skeleton:k})]})})})})})})})})},Ct={alt:"altKey",ctrl:"ctrlKey",mod:typeof window<"u"&&/Mac|iPod|iPhone|iPad/.test(window.navigator.platform)?"metaKey":"ctrlKey",shift:"shiftKey"};function Tt(e){return"Alt"===e.key}const Dt=e=>{const{comlink:t,refresh:n}=e,r=m(0),i=m(0);return a((()=>t.on("presentation/refresh",(e=>{if("manual"===e.source){clearTimeout(r.current);const i=n(e);if(!1===i)return;t.post("visual-editing/refreshing",e);let o=!1;r.current=window.setTimeout((()=>{t.post("visual-editing/refreshed",e),o=!0}),3e3),i?.finally?.((()=>{o||(clearTimeout(r.current),t.post("visual-editing/refreshed",e))}))}else if("mutation"===e.source){clearTimeout(i.current);const r=n(e);if(!1===r)return;t.post("visual-editing/refreshing",e),i.current=window.setTimeout((()=>{const r=n(e);!1!==r&&(t.post("visual-editing/refreshing",e),r?.finally?.((()=>{t.post("visual-editing/refreshed",e)}))||t.post("visual-editing/refreshed",e))}),1e3),r?.finally?.((()=>{t.post("visual-editing/refreshed",e)}))||t.post("visual-editing/refreshed",e)}}))),[t,n]),null},zt=s=>{const{components:c,history:l,portal:p=!0,refresh:u,zIndex:m}=s,[h,f]=d(null),[g,y]=d(null);a((()=>{f(i()),y(o())}),[]);const[w,b]=d(null);a((()=>{if(!1===p)return;const e=document.createElement("sanity-visual-editing");return document.documentElement.appendChild(e),b(e),()=>{b(null),document.documentElement.contains(e)&&document.documentElement.removeChild(e)}}),[p]);const x=function(e=!0){const[t,n]=d();return a((()=>{if(!e)return;const t=Pe({name:"visual-editing",connectTo:"presentation"},$e().provide({actors:r()}));n(t);const i=t.start();return()=>{i(),n(void 0)}}),[e]),t}(!0===h||!0===g);!function(e){a((()=>{if(!e)return;const t=function(e){const t=new Re(1),n=new Ae;return e.fetch("visual-editing/snapshot-welcome",void 0,{suppressWarnings:!0}).then((e=>{t.next(e.event)})).catch((()=>{})),e.on("presentation/snapshot-event",(e=>{"reconnect"===e.event.type&&t.next(e.event),"mutation"===e.event.type&&n.next(e.event)})),je(t,n)}(e),n=Te(e),r=Ce(n,{input:{client:{withConfig:()=>{}},sharedListener:t}});r.start();const i=new AbortController,o=e.onStatus((()=>{e.fetch("visual-editing/features",void 0,{signal:i.signal,suppressWarnings:!0}).then((e=>{e.features.optimistic&&De(r)})).catch((()=>{console.warn("[@sanity/visual-editing] Package version mismatch detected: Please update your Sanity studio to prevent potential compatibility issues.")}))}),"connected");return()=>{r.stop(),i.abort(),o()}}),[e])}(x);const k=/* @__PURE__ */t(n,{children:[null!==h&&null!==g&&/* @__PURE__ */e($t,{comlink:x,componentResolver:c,inFrame:h,inPopUp:g,zIndex:m}),x&&/* @__PURE__ */t(n,{children:[
/* @__PURE__ */e(Ve,{comlink:x,history:l}),
/* @__PURE__ */e(Le,{comlink:x}),u&&/* @__PURE__ */e(Dt,{comlink:x,refresh:u})]})]});return!1!==p&&w?v(k,w):k};zt.displayName="VisualEditing";export{zt as VisualEditing,Ie as createDataAttribute,Te as createDatasetMutator,ze as createDocumentMutator,_e as emptyActor,ce as useDocuments,be as useOptimistic,ge as useOptimisticActor};//# sourceMappingURL=index.js.map
